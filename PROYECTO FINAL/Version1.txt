;=====================
; EEPROM + 2 POTENCIOMETROS + LCD (PORTD y PORTE)
;=====================

    #INCLUDE "P16F887.INC"
    
    __CONFIG _CONFIG1, (_CP_OFF & _WDT_OFF & _PWRTE_ON & _XT_OSC & _LVP_OFF)
    __CONFIG _CONFIG2, _BOR21V

;===== REGISTROS =====
VAL1      EQU 0x20
VAL2      EQU 0x21
REG1      EQU 0x22
REG2     EQU 0x23  
REG3     EQU 0x24  
REG4     EQU 0x25
REG5      EQU 0X26
REGSL	  EQU 0X27
REGSH     EQU 0X28
REGC1 EQU 0X2A
REGD1 EQU 0X2B
REGU1 EQU 0X2C
REGC2 EQU 0X2D
REGD2 EQU 0X2E
REGU2 EQU 0X2F
REGM  EQU 0X30
REGC  EQU 0X31
REGD  EQU 0X32
REGU  EQU 0X33

;===== INICIO =====
    ORG 0x00
    GOTO INICIO

;=====================
; CONFIGURACIÓN LCD
;=====================
;=== CONFIGURACION LDC ===
LCD_INIT
	BCF PORTE,0
	BCF PORTE,1
COMANDO3 ;######MODO ENTRADA CARACTERES#####
	MOVLW B'00000110'
	MOVWF PORTD
	CALL ENABLE
COMANDO2 ;########APAGADO ENCENDIDO PANTALLA######
	MOVLW B'00001111'
	MOVWF PORTD
	CALL ENABLE
COMANDO1 ;#############FUNCION SET##########
	MOVLW B'00111100'
	MOVWF PORTD
	CALL ENABLE
	RETURN
COMANDO4 ;######CURSOR HOME#####
	BCF PORTE,0
	BCF PORTE,1
	MOVLW B'00000010'
	MOVWF PORTD
	CALL ENABLE
	RETURN
COMANDO5 ;####BORRADO DE PANTALLA
	BCF PORTE,0
	BCF PORTE,1
	MOVLW B'00000001'
	MOVWF PORTD
	CALL ENABLE
	RETURN	

ENABLE
	BSF PORTE,2
	CALL TIEMPO2
	BCF PORTE,2
	RETURN

TIEMPO2
	MOVLW .13
	MOVWF REG4
SIGO2
	MOVLW .255
	MOVWF REG5
	DECFSZ REG5
	GOTO $-.1
	DECFSZ REG4
	GOTO SIGO2

RETURN

;=====================
; CONFIGURACIÓN ADC
;=====================
SETUP_ADC
	BANKSEL ANSEL ;selecciono el banco 3
	CLRF ANSELH
	CLRF ANSEL    
	BSF ANSEL,0   ;limpio los analógicos, menos el RA0/AN0
	BSF ANSEL,1	  ;limpio los analógicos, menos el RA1/AN1

	BANKSEL TRISA
	CLRF TRISA
	BSF TRISA,0            ; RA0 entrada
	BSF TRISA,1            ; RA1 entrada
	CLRF TRISD    ; declaro como salida los pines del bus de datos 8 bits
	CLRF TRISE    ; declaro como salida los pines de control RW RS y E

	BANKSEL ADCON1
	MOVLW b'10000000'      ; Justificación derecha
	MOVWF ADCON1

	BANKSEL ADCON0
	MOVLW b'01000001'      ; Canal AN0 (por defecto), ADC ON
	MOVWF ADCON0
	CLRF PORTD      ;LIMPIO VALORES PARA EL MÓDULO LCD (BUS Y PINES CONTROL)
	CLRF PORTE
	RETURN

LEER_ADC
    BSF ADCON0,GO_DONE
ESPERA
    BTFSC ADCON0,GO_DONE
    GOTO ESPERA
    BANKSEL ADRESL
    MOVF ADRESL,W
    BANKSEL PORTC
    RETURN

;=====================
; PROGRAMA PRINCIPAL
;=====================
INICIO
	BANKSEL TRISB
	BSF TRISB,2            ; Botón guardar
	CLRF TRISD
	CLRF TRISE

	BANKSEL PORTB
	CLRF PORTB
	CLRF PORTD
	CLRF PORTE

	CALL LCD_INIT
	CALL SETUP_ADC

PRINCIPAL
	; Leer POT 1 (AN1)
	BCF ADCON0,CHS0
	BCF ADCON0,CHS1
	BCF ADCON0,CHS2
	CALL LEER_ADC
	MOVWF VAL1

	; Leer POT 2 (AN2)
	BSF ADCON0,CHS0
	BCF ADCON0,CHS1
	BCF ADCON0,CHS2
	CALL LEER_ADC
	MOVWF VAL2

	; Mostrar valores
	CALL MOSTRAR_LCD

	; Si se presiona botón, guardar EEPROM
	BANKSEL PORTB
	BTFSS PORTB,2
	GOTO PRINCIPAL
	CALL GUARDAR_EEPROM
	GOTO PRINCIPAL

;=====================
; GUARDAR EEPROM
;=====================
GUARDAR_EEPROM
	; Guarda VAL1
	MOVLW 0x00
	MOVWF EEADR
	MOVF VAL1,W
	MOVWF EEDAT
	CALL ESCRIBIR

	; Guarda VAL2
	MOVLW 0x01
	MOVWF EEADR
	MOVF VAL2,W
	MOVWF EEDAT
	CALL ESCRIBIR
	RETURN

ESCRIBIR
	BANKSEL EECON1
	BSF EECON1,WREN
	MOVLW 0x55
	MOVWF EECON2
	MOVLW 0xAA
	MOVWF EECON2
	BSF EECON1,WR
ESPERA_WR
	BTFSC EECON1,WR
	GOTO ESPERA_WR
	BCF EECON1,WREN
	RETURN

;=====================
; MOSTRAR EN LCD
;=====================
MOSTRAR_LCD
	BSF PORTE,0     ; RS=1 (datos)
	BCF PORTE,1     ; RW=0

	; --- Mostrar "B:" ---
	MOVLW 'B'
	MOVWF PORTD
	CALL ENABLE
	MOVLW ':'
	MOVWF PORTD
	CALL ENABLE

	; --- Descomponer VAL1 ---
	MOVF VAL1,W
	MOVWF REGSL
	CALL DESCOMP
	; Copiar resultados
	MOVF REGC,W
	MOVWF REGC1
	MOVF REGD,W
	MOVWF REGD1
	MOVF REGU,W
	MOVWF REGU1

	; --- Descomponer VAL2 ---
	MOVF VAL2,W
	MOVWF REGSL
	CALL DESCOMP
	MOVF REGC,W
	MOVWF REGC2
	MOVF REGD,W
	MOVWF REGD2
	MOVF REGU,W
	MOVWF REGU2

	; --- Mostrar VAL1 ---
	MOVF REGC1,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	MOVF REGD1,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	MOVF REGU1,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	; Espacio
	MOVLW ' '
	MOVWF PORTD
	CALL ENABLE

	; --- Mostrar "A:" ---
	MOVLW 'A'
	MOVWF PORTD
	CALL ENABLE
	MOVLW ':'
	MOVWF PORTD
	CALL ENABLE

	; --- Mostrar VAL2 ---
	MOVF REGC2,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	MOVF REGD2,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	MOVF REGU2,W
	ADDLW '0'
	MOVWF PORTD
	CALL ENABLE

	CALL LIMPIO

	RETURN

LIMPIO
	CALL TIEMPO
	LCD_CONFIG2
		BCF PORTE,1;RS
		BCF PORTE,0;RW
	COMANDOB
		MOVLW B'0000010';b'00000001' para borrar en vez de escribir
		MOVWF PORTD
		CALL ENABLE

RETURN

TIEMPO
	MOVLW .3
	MOVWF REG1
	MOVLW .26
	MOVWF REG2
	MOVLW .255
	MOVWF REG3
	DECFSZ REG3
	GOTO $-.1
	DECFSZ REG2
	GOTO $-.5
	DECFSZ REG1
	GOTO $-.8
	RETURN

DESCOMP
	CLRF REGC
	CLRF REGD
	CLRF REGU
	CLRF REGM

CENTENA	
	MOVLW .100
	SUBWF REGSL,F
	BTFSC STATUS,C
	GOTO $+.3
	ADDWF REGSL
	GOTO DECENA
	INCF REGC,F
	GOTO $-.6

DECENA
	MOVLW .10
	SUBWF REGSL,F
	BTFSC STATUS,C
	GOTO $+.3
	ADDWF REGSL
	GOTO UNIDAD
	INCF REGD,F
	GOTO $-.6

UNIDAD
	MOVLW .1
	SUBWF REGSL,F
	BTFSC STATUS,C
	GOTO $+.3
	ADDWF REGSL
	RETURN
	INCF REGU,F
	GOTO $-.6

	END
